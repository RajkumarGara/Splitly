<template name="Analysis">
	<h2 class="page-title">
		<i class="bi bi-graph-up-arrow"></i>
		Spending Insights
	</h2>
	
	{{#if subscriptionReady}}
		{{#if hasData}}
		{{#with global}}
			<!-- Stat Cards -->
			<div class="row g-3 mb-4">
				<div class="col-md-3 col-6">
					<div class="stat-card">
						<div class="stat-icon"><i class="bi bi-cash-stack"></i></div>
						<div class="stat-label">Total Spent</div>
						<div class="stat-value">${{totalSpent}}</div>
					</div>
				</div>
				<div class="col-md-3 col-6">
					<div class="stat-card">
						<div class="stat-icon"><i class="bi bi-cart3"></i></div>
						<div class="stat-label">Items (no tax)</div>
						<div class="stat-value">${{totalItemSpent}}</div>
					</div>
				</div>
				<div class="col-md-3 col-6">
					<div class="stat-card">
						<div class="stat-icon"><i class="bi bi-percent"></i></div>
						<div class="stat-label">Tax Total</div>
						<div class="stat-value">${{taxTotal}}</div>
					</div>
				</div>
				<div class="col-md-3 col-6">
					<div class="stat-card">
						<div class="stat-icon"><i class="bi bi-receipt"></i></div>
						<div class="stat-label">Avg / Receipt</div>
						<div class="stat-value">${{avgPerReceipt}}</div>
					</div>
				</div>
			</div>
			<!-- Per User Spending -->
			<div class="analysis-section">
				<div class="section-header">
					<div>
						<h5 class="section-title">
							<i class="bi bi-people-fill"></i>
							Per User
						</h5>
						<p class="section-subtitle">(tax included equally)</p>
					</div>
				</div>
				
				<div class="user-filter-chips">
					{{#each filterUsers}}
						<button class="filter-chip {{#if (activeClass userId)}}active{{/if}}" data-id="{{userId}}">
							{{name}}
						</button>
					{{/each}}
					{{#if hasFilter}}
						<button class="filter-chip" id="clearFilter">
							<i class="bi bi-x-circle"></i> Clear
						</button>
					{{/if}}
				</div>
				
				<div class="user-spending-list">
					{{#each perUserGlobal}}
						<div class="user-spending-item">
							<div class="user-spending-row">
								<div class="user-name">{{name}}</div>
								<div class="spending-bar-container">
									<div class="spending-bar-fill" style="width: {{barWidth}}%;"></div>
								</div>
								<div class="spending-amount">
									<span class="amount-badge">${{amount}}</span>
									<span class="percent-badge">{{percent}}%</span>
								</div>
							</div>
						</div>
					{{/each}}
				</div>
			</div>
			<!-- Monthly Trend & Insights -->
			<div class="row g-4 mb-4">
				<div class="col-md-6">
					<div class="analysis-section">
						<div class="section-header">
							<h5 class="section-title">
								<i class="bi bi-calendar3"></i>
								Monthly Trend
							</h5>
						</div>
						<div class="monthly-list">
							{{#each monthlyBreakdown}}
								<div class="monthly-item">
									<div class="monthly-label">
										<i class="bi bi-calendar-check"></i>
										{{month}}
									</div>
									<div class="monthly-value">${{total}}</div>
								</div>
							{{/each}}
						</div>
					</div>
				</div>
				<div class="col-md-6">
					<div class="analysis-section">
						<div class="section-header">
							<h5 class="section-title">
								<i class="bi bi-shop"></i>
								Store Breakdown
							</h5>
						</div>
						<div class="top-items-list">
							{{#each storeBreakdown}}
								<div class="store-item">
									<div class="store-header">
										<div class="store-name" title="{{name}}">{{name}}</div>
										<div class="store-total">${{total}}</div>
									</div>
									<div class="store-details">
										<span class="store-stat">{{count}} visits</span>
										<span class="store-stat">{{itemCount}} items</span>
										<span class="store-stat">${{avgPerVisit}}/visit</span>
									</div>
								</div>
							{{/each}}
						</div>
					</div>
				</div>
			</div>
			
			<!-- Most Valuable & Most Frequent Items -->
			<div class="row g-4">
				<div class="col-md-6">
					<div class="analysis-section">
						<div class="section-header">
							<h5 class="section-title">
								<i class="bi bi-cash-coin"></i>
								Most Valuable Items
							</h5>
						</div>
						<div class="top-items-list">
							{{#each mostValuable}}
								<div class="top-item">
									<div class="item-rank">{{incIndex @index}}</div>
									<div class="item-name" title="{{name}}">{{name}}</div>
									<div class="item-details">
										<span class="item-value">${{total}}</span>
										<span class="item-count">×{{count}}</span>
									</div>
								</div>
							{{/each}}
						</div>
					</div>
				</div>
				<div class="col-md-6">
					<div class="analysis-section">
						<div class="section-header">
							<h5 class="section-title">
								<i class="bi bi-star-fill"></i>
								Most Purchased Items
							</h5>
						</div>
						<div class="top-items-list">
							{{#each mostFrequent}}
								<div class="top-item">
									<div class="item-rank">{{incIndex @index}}</div>
									<div class="item-name" title="{{name}}">{{name}}</div>
									<div class="item-details">
										<span class="item-count-badge">×{{count}}</span>
										<span class="item-value">${{total}}</span>
									</div>
								</div>
							{{/each}}
						</div>
					</div>
				</div>
			</div>
			
			<div class="analysis-footer">
				<p class="analysis-footer-text">
					<i class="bi bi-receipt-cutoff"></i>
					Receipts analyzed: <strong>{{receiptCount}}</strong>
				</p>
			</div>
		{{/with}}
		{{else}}
			<div class="analysis-empty-state">
				<i class="bi bi-pie-chart analysis-empty-icon"></i>
				<p class="analysis-empty-text">No data to analyze yet. Create bills to see insights.</p>
				<a href="/" class="btn btn-purple btn-lg">
					<i class="bi bi-plus-circle"></i> Add Your First Receipt
				</a>
			</div>
		{{/if}}
	{{/if}}
</template>